
<!DOCTYPE html> 
<html> 
<head> 
    <title>Home Questionnaire</title> 
    
    <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-KWSH4F9');</script>
    <!-- End Google Tag Manager -->


    <script>
        class test_plugin {
          constructor() {
            this.name = 'Test Plugin';
            // before, enrichment, destination, after
            this.type = 'before';
            this.version = '1';
          }
            
          isLoaded() {
            return true;
          }
           
          async load(ctx, analytics) {
        
            // parse URL for utm params
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const campaign_id = urlParams.get('campaign_id')
            const npi = urlParams.get('npi');
        
            var data_to_send = JSON.stringify({ campaign_id: campaign_id, npi: npi });
        
            var myHeaders = new Headers();
            myHeaders.append("Content-Type", "text/plain");
        
            var requestOptions = {
              method: 'POST',
              headers: myHeaders,
              body: data_to_send,
              redirect: 'follow'
            };
        
            fetch("https://demo.audiencelogy.com/relevate/enrichment/enrichUTM", requestOptions)
              .then(response => response.json())
              .then(result => localStorage.setItem("utm_list", JSON.stringify(result.results)))
              .catch(error => console.log('error', error));
        
            return;
          }
            
          async track(ctx) {
            ctx.event.properties.utm_params = JSON.parse(localStorage.getItem("utm_list"));
            return ctx;
          }
        
          async page(ctx) {
            ctx.event.properties.utm_params = JSON.parse(localStorage.getItem("utm_list"));
            return ctx;
          }
        }

        /*window.addEventListener('gtm:loaded', function (event) {
          // give the necessary tag a chance to run
          setTimeout(function () {
            await window.analytics.register(new test_plugin())
          }, 500)
        })*/
        await window.analytics.register(new test_plugin())
        
    </script>
    
    
    <!--Scroll Snippet -->
    <script>
        var lastRun = 0;
        var delay = 1000;
        window.onload = function () {
             window.onscroll = function () {
                var h = document.documentElement, 
                    b = document.body,
                    st = 'scrollTop',
                    sh = 'scrollHeight';
                var scrollDepth = ((h[st]||b[st]) / ((h[sh]||b[sh]) - h.clientHeight) * 100);
                if (lastRun >= (Date.now() - delay)) {
                    if (scrollDepth == 25) {
                        analytics.track("Scrolled 25%");
                    } else if (scrollDepth == 50) {
                        analytics.track("Scrolled 50%");
                    } else if (scrollDepth == 75) {
                        analytics.track("Scrolled 75%");
                    } else if (scrollDepth == 100) {
                        analytics.track("Scrolled 100%");
                    };
                }
                lastRun = Date.now();
            };
        };
    </script>

    </head> 

<body>
    
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-KWSH4F9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <script>
            //just adding a constructor to the String object
            // will be using it to create a userID from email
            String.prototype.hashCode = function() {
                var hash = 0;
                if (this.length == 0) {
                    return hash;
                }
                for (var i = 0; i < this.length; i++) {
                    var char = this.charCodeAt(i);
                    hash = ((hash<<5)-hash)+char;
                    hash = hash & hash; // Convert to 32bit integer
                }
                return hash;
            }
    </script>
    

<!-- form with all fields -->    
<h1>Segment City</h1> 
<p>A testing website to play around with Segment functions.</p>  

<!-- login form & button -->
<form name="login_form" onsubmit="login(event)">
    User ID: <input name="userId" required="" size="20" type="text"/>
    <input name="submit" type="submit" value="Login">
    <br><br>
</form>

<script type="text/javascript">
    function login(e) {
        var form = e.target;
        var userId = form["userId"].value;
        analytics.identify(userId)
    }
</script>

<form name="travel" onsubmit="identify(event)">
     What is your favorite travel destination?
    <input name="destination" required="" size="81" type="text" value="Bergamo"/> 
    <br><br><br> 
    Any recommendations (cool things to do, places to visit or restaurants to eat)? 
    <br><br> 
    <textarea cols="81" name="details" required="" rows="10">check out the fantastic food</textarea> 
    <br><br> 
    Name: <input name="fullname" required="" size="75" type="text" value="Johnny Cash"/> 
    <br><br> 
    Email: <input name="email" required="" size="75" type="email" value="johnny@cash.io"/> 
    <br><br>
    
    Segment userId: <input name="userId" required="" size="75" type="text" value="jc1000000"/> 
    <br><br>
    
    <input name="submit" type="submit" value="submit"/>
</form> 


    <!--Placeholder for identify and track script -->
    <script type="text/javascript">
      function identify(e) {
        e.preventDefault();
        var form = e.target;
        var email = form["email"].value;
        var fullname = form["fullname"].value;
        var destination = form["destination"].value;
        var details = form["details"].value;
        var user = {
            email: email, 
            name: fullname, 
            destination: destination, 
            details: details
        };
        var myUserId = form["userId"].value;
          
        // call identify event first  
        analytics.identify(myUserId, {
            email: email, 
            name: fullname
        });
          
        // call track event  
        analytics.track('Form Submitted', 
            {
                label: 'client side',
                user
                });
          
        analytics.alias(myUserId);
      }
    </script>
    
    <div id="target-container"></div>
    
    <br/><br/>
    
    
    <!-- button to reset a.js -->
    <button type="button" onclick="analytics.reset();">analytics.reset();</button>

    <!-- extra button for testing purposes -->
    <button type="button" onclick="analytics.track('test button clicked');">Test Button</button>

    <!-- link to a second page to test referrer -->
    <a href="https://stesegment.github.io/sample.html">Link to a second page</a>
   
    
</body> 
</html>
